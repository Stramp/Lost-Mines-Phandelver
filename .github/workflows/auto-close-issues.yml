name: Auto-Close Issues on Merge

on:
  push:
    branches: [ main, master ]
    types: [ push ]

jobs:
  close-issue:
    name: Close related issue
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Busca todo hist√≥rico para ver commits merged

    - name: Setup GitHub CLI
      run: |
        type gh > /dev/null 2>&1 || (echo "GitHub CLI n√£o encontrado" && exit 1)
        gh --version

    - name: Extract issue number and close
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Busca √∫ltimo commit merged
        LAST_COMMIT=$(git log -1 --pretty=%B)
        LAST_BRANCH=$(git log -1 --pretty=%D)

        echo "√öltimo commit: $LAST_COMMIT"
        echo "√öltima branch: $LAST_BRANCH"

        ISSUE_NUM=""

        # Tenta extrair #n√∫mero do commit message (padr√£o: "feat(Scope): ... #568")
        if echo "$LAST_COMMIT" | grep -qE '#[0-9]+'; then
          ISSUE_NUM=$(echo "$LAST_COMMIT" | grep -oE '#[0-9]+' | head -1 | sed 's/#//')
          echo "‚úÖ Issue #$ISSUE_NUM encontrada no commit message"
        # Tenta extrair do nome da branch no hist√≥rico (feat/issue-XXX__...)
        elif echo "$LAST_BRANCH" | grep -qE 'issue-[0-9]+'; then
          ISSUE_NUM=$(echo "$LAST_BRANCH" | grep -oE 'issue-[0-9]+' | head -1 | sed 's/issue-//')
          echo "‚úÖ Issue #$ISSUE_NUM encontrada no nome da branch"
        # Tenta buscar em todos os commits recentes merged
        else
          # Busca nos √∫ltimos 10 commits por padr√£o de branch ou commit message
          for i in {1..10}; do
            COMMIT_MSG=$(git log -$i --pretty=%B -1 2>/dev/null || echo "")
            COMMIT_BRANCH=$(git log -$i --pretty=%D -1 2>/dev/null || echo "")

            if echo "$COMMIT_MSG" | grep -qE '#[0-9]+'; then
              ISSUE_NUM=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | head -1 | sed 's/#//')
              echo "‚úÖ Issue #$ISSUE_NUM encontrada no commit #$i"
              break
            elif echo "$COMMIT_BRANCH" | grep -qE 'issue-[0-9]+'; then
              ISSUE_NUM=$(echo "$COMMIT_BRANCH" | grep -oE 'issue-[0-9]+' | head -1 | sed 's/issue-//')
              echo "‚úÖ Issue #$ISSUE_NUM encontrada no commit #$i"
              break
            fi
          done
        fi

        # Fecha a issue se encontrou n√∫mero
        if [ -n "$ISSUE_NUM" ]; then
          echo "üîí Fechando issue #$ISSUE_NUM..."

          # Verifica se issue est√° aberta antes de fechar
          ISSUE_STATE=$(gh issue view $ISSUE_NUM --repo ${{ github.repository }} --json state -q .state 2>/dev/null || echo "not_found")

          if [ "$ISSUE_STATE" = "OPEN" ]; then
            gh issue close $ISSUE_NUM --repo ${{ github.repository }} \
              --comment "‚úÖ **Task completada e merged para main**

**Status:**
- ‚úÖ C√≥digo merged para \`main\`
- ‚úÖ Build passou com sucesso
- ‚úÖ Issue fechada automaticamente via GitHub Actions

**Pr√≥ximo passo:** Mover card no Project board para 'Done' (se aplic√°vel)."
            echo "‚úÖ Issue #$ISSUE_NUM fechada com sucesso"
          elif [ "$ISSUE_STATE" = "CLOSED" ]; then
            echo "‚ÑπÔ∏è Issue #$ISSUE_NUM j√° est√° fechada"
          else
            echo "‚ö†Ô∏è Issue #$ISSUE_NUM n√£o encontrada ou sem permiss√£o"
          fi
        else
          echo "‚ÑπÔ∏è Nenhuma issue encontrada para fechar (nenhum padr√£o #n√∫mero ou issue-XXX detectado)"
        fi
